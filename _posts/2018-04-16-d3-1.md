---
published: true
layout: post
title: "æ•°æ®å¯è§†åŒ–ï¼šD3 åŸºç¡€å…¥é—¨å­¦ä¹ ç¬”è®°ï¼ˆä¸€ï¼‰"
date: 2018-04-16
---

### D3 : Data-Driven Documents

D3 çš„å…¨ç§°æ˜¯ Data-Driven Documentsï¼Œå°±æ˜¯æ•°æ®é©±åŠ¨æ–‡æ¡£ï¼ŒWhat? å…¶å®å°±æ˜¯ä¸€ä¸ª JavaScript çš„å‡½æ•°åº“ï¼Œä¸»è¦ç”¨æ¥åšæ•°æ®å¯è§†åŒ–ã€‚[D3 Gallery] å±•ç¤ºäº†ä½¿ç”¨ D3 åšå‡ºæ¥çš„å„ç§æ•°æ®å¯è§†åŒ–çš„æ•ˆæœã€‚


### D3 vs HighCharts vs Echarts

åœ¨æ•°æ®å¯è§†åŒ–æ–¹é¢ï¼Œé™¤äº† D3 ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›æ¯”è¾ƒæµè¡Œçš„å·¥å…·ï¼Œæ¯”å¦‚ HighChartsã€ç™¾åº¦çš„ECharts ç­‰ç­‰ã€‚ğŸ‘‡è¿™é‡Œç®€å•åœ°å¯¹è¿™ä¸‰ä¸ªå¯è§†åŒ–çš„åº“åšäº†ä¸€ä¸‹å¯¹æ¯”ã€‚

- åœ¨**æ¸²æŸ“å¼•æ“**ä¸Šï¼Œå¯è§†åŒ–åº“é€šå¸¸ä¼šé€‰æ‹© SVG æˆ–è€… Canvas è¿›è¡Œæ¸²æŸ“ã€‚D3 å’Œ HighCharts ä¸»è¦æ˜¯åŸºäº SVG, ECharts ä¸»è¦åŸºäº Canvas;

( D3 4.0 å¼€å§‹ä¹Ÿæ”¯æŒ Canvas æ¸²æŸ“, ä½†æ˜¯å¯¹äº Canvas çš„æ”¯æŒç¨‹åº¦è¿œä¸åŠ SVG, å¤§éƒ¨åˆ† D3 é¡¹ç›®ä½¿ç”¨çš„æ˜¯ SVG; Echarts 4.0 å¼€å§‹æä¾›äº† SVG æ¸²æŸ“å™¨ï¼Œä½† Echarts é»˜è®¤ä½¿ç”¨çš„æ˜¯ Canvas æ¸²æŸ“ã€‚å¦å¤–ï¼Œå¯¹äºä½ç‰ˆæœ¬ IE, HighCharts å’Œ Echarts ä½¿ç”¨ VML è¿›è¡Œæ¸²æŸ“ã€‚ï¼‰

- åœ¨**æµè§ˆå™¨å…¼å®¹æ€§**ä¸Šï¼Œä¸‰è€…éƒ½æ”¯æŒä¸»æµçš„ç°ä»£æµè§ˆå™¨ï¼ˆChrome / Firefox / Safari ...)ï¼Œå¯¹äºä½ç‰ˆæœ¬æµè§ˆå™¨ï¼ŒD3 æ”¯æŒåˆ° IE9+, HighCharts æ”¯æŒåˆ° IE6+, Echarts æ”¯æŒåˆ° IE8+;

- åœ¨**ä½¿ç”¨æ–¹æ³•**ä¸Šï¼ŒHighCharts å’Œ Echarts ç”¨æ³•æ¯”è¾ƒç›¸ä¼¼ï¼Œé€šè¿‡ç®€å•çš„é…ç½®è¯­æ³•å°±å¯ä»¥ç”Ÿæˆå¯¹åº”çš„å›¾è¡¨ï¼Œå¯èƒ½å¹¶ä¸éœ€è¦æˆ‘ä»¬å¯¹ SVG æˆ– Canvas é¢„å…ˆæœ‰å¤ªå¤šäº†è§£ï¼› D3 è™½ç„¶æ˜¯åšæ•°æ®å¯è§†åŒ–çš„ï¼Œä½†å…¶å®å¹¶ä¸æ˜¯ä¸€ä¸ªçœŸæ­£æ„ä¹‰ä¸Šçš„å›¾å½¢ç»˜åˆ¶çš„åº“ï¼Œç»˜åˆ¶å›¾è¡¨çš„æ—¶å€™éœ€è¦æˆ‘ä»¬è‡ªå·±ç»“åˆä½¿ç”¨ SVG æˆ–è€… Canvas, D3 çš„åŠŸèƒ½ä¸»è¦æ˜¯é›†ä¸­åœ¨æ•°æ®å¤„ç†æ–¹é¢ï¼Œå°†æ•°æ®æ˜ å°„åˆ°å›¾å½¢ï¼Œä¸­é—´æœ‰å¾ˆå¤šçç¢å¤æ‚çš„è¿‡ç¨‹ï¼ŒD3 æä¾›äº†ä¸€ç³»åˆ—å°è£…å¥½çš„å‡½æ•°ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿæ–¹ä¾¿åœ°å®ç°ä»æ•°æ®åˆ°å›¾å½¢çš„è½¬æ¢ã€‚

æ€»çš„æ¥çœ‹ï¼Œè¿™ä¸‰ä¸ªå¯è§†åŒ–çš„åº“ï¼Œå„æœ‰ä¼˜ç¼ºï¼ŒD3çš„ç›¸å¯¹ä¼˜åŠ¿æ˜¯æ›´åŠ çµæ´»ï¼Œæ‹“å±•æ€§æ›´å¥½ä¸€äº›ã€‚

### D3 åŸºç¡€æ¦‚å¿µ & ç”¨æ³•

#### Selection é€‰æ‹©é›†

D3 å¯¹ DOM æ“ä½œè¿›è¡Œäº†å°è£…ã€‚å’Œ jQuery ç±»ä¼¼ï¼ŒD3 ä¾èµ–äºé€‰æ‹©ç¬¦é€‰ä¸­ä¸€ç»„å…ƒç´ ï¼Œå»ºç«‹é€‰æ‹©é›†ï¼Œç„¶åä½¿ç”¨é€‰æ‹©é›†å¯¹è±¡çš„æ–¹æ³•æ“ä½œ DOMï¼Œæ¯”å¦‚è®¾ç½®å±æ€§ã€æ ·å¼ã€æ–‡æœ¬å†…å®¹ä»¥åŠç›‘å¬ DOM äº‹ä»¶ç­‰ï¼Œå¹¶ä¸”ï¼Œ D3 ä¹Ÿæ”¯æŒé“¾å¼è°ƒç”¨çš„å†™æ³•ã€‚

- é€‰æ‹©å…ƒç´ 
	- select()ï¼šä½¿ç”¨ç¬¬ä¸€ä¸ªåŒ¹é…çš„å…ƒç´ åˆ›å»ºé€‰æ‹©é›†ï¼›
	- selectAll()ï¼šä½¿ç”¨å…¨éƒ¨åŒ¹é…çš„å…ƒç´ åˆ›å»ºé€‰æ‹©é›†ï¼›

```
var body = d3.select("body");
var container = body.select("#container");

var p = body.selectAll("p");
var btns = body.selectAll(".btnâ€);
```

- æ’å…¥å…ƒç´ 
	- append(type) ï¼šåœ¨é€‰æ‹©é›†æœ«å°¾æ’å…¥å…ƒç´ ï¼›
	- insert(type[, before]) ï¼š åœ¨é€‰æ‹©é›†åŒ¹é… before é€‰æ‹©å™¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ å‰æ’å…¥å…ƒç´ ï¼›

```
// å½“ä¸æŒ‡å®š before æ—¶ï¼Œinsert å’Œ append ä¸€æ ·ï¼Œéƒ½æ˜¯æ’å…¥åœ¨æœ«å°¾
// ä¸‹é¢ä¸¤ä¸ªå†™æ³•æ•ˆæœä¸€æ ·ğŸ‘‡
p.append("div");
p.insert("div");

// è¦è®© insert æ’å…¥åœ¨é€‰æ‹©é›†ç¬¬ä¸€ä¸ªä½ç½®ï¼Œå†™æ³•å¦‚ä¸‹ï¼š
p.insert("divâ€, ":first-child");
```
- åˆ é™¤å…ƒç´ 
  - remove()

- å…¶ä»–
	- selection.attr - get or set an attribute.
	- selection.classed - get, add or remove CSS classes.
	- selection.style - get or set a style property.
	- selection.property - get or set a (raw) property.
	- selection.text - get or set the text content.
	- selection.html - get or set the inner HTML.

ã€‚ã€‚ã€‚

```
d3.selectAll("circle")
  .style("fill", "blue")
  .attr("r", 30)
  .attr("cy", function() { return Math.random() * 400 });
```

- äº‹ä»¶ç›‘å¬
	- selection.on(typenames[, listener[, capture]])

	è·Ÿä¸€èˆ¬çš„äº‹ä»¶ç›‘å¬ï¼ŒåŒºåˆ«åœ¨äºï¼ŒD3 çš„äº‹ä»¶ç›‘å¬å‡½æ•°åœ¨è§¦å‘æ—¶ï¼Œä¼ å…¥çš„å‚æ•°ä¸­æ²¡æœ‰ DOM äº‹ä»¶å¯¹è±¡ï¼ŒD3 æä¾›ä¸€ä¸ªå…¨å±€å˜é‡æ¥æä¾› DOM äº‹ä»¶å¯¹è±¡ï¼šd3.eventã€‚è¿™ä¸ªå¯¹è±¡ä»…åœ¨ç›‘å¬å‡½æ•°ä¸­æœ‰æ•ˆã€‚æ¯å½“äº‹ä»¶è§¦å‘æ—¶ï¼ŒD3 å°±å°† DOM äº‹ä»¶å¯¹è±¡èµ‹ç»™ d3.event, å¹¶åœ¨ç›‘å¬å™¨å¤„ç†å®Œä¹‹åå°†å…¶æ¸…ç†ã€‚

	åˆ©ç”¨äº‹ä»¶ç›‘å¬å¯ä»¥æ·»åŠ äº¤äº’æ•ˆæœï¼Œæ¯”å¦‚æ·»åŠ  mousemove æ•ˆæœç­‰ã€‚è™½ç„¶å¯ä»¥é€šè¿‡ DOM äº‹ä»¶å¯¹è±¡çš„ pageX å’Œ pageY è·å–é¼ æ ‡ä½ç½®ï¼Œä½†æ˜¯ D3 æä¾›äº†æ›´å¥½çš„æ–¹æ³•ï¼šd3.mouse(container)ï¼Œå‚æ•°æ˜¯ä¸€ä¸ª html å…ƒç´ ï¼Œd3.mouse() è¿”å›é¼ æ ‡ä½ç½®ç›¸å¯¹äºå®¹å™¨å…ƒç´ çš„ x,y åæ ‡ã€‚

ğŸ· **å®˜æ–¹æ–‡æ¡£**ï¼š [D3 Selection]

#### Data Join æ•°æ®ç»‘å®š

D3 å°†æ•°æ®å¯è§†åŒ–æŠ½è±¡ä¸ºæ•°æ®ä¸å¯è§†åŒ–å…ƒç´ çš„åŒ¹é…ï¼Œä¸€ä¸ªæ•°æ®å¯¹åº”ä¸€ä¸ªå¯è§†åŒ–å…ƒç´ ã€‚

- datum()ï¼šç»‘å®šä¸€ä¸ªæ•°æ®åˆ°é€‰æ‹©é›†ä¸Šï¼›
- data()ï¼šç»‘å®šä¸€ä¸ªæ•°ç»„åˆ°é€‰æ‹©é›†ä¸Šï¼Œæ•°ç»„çš„å„é¡¹å€¼åˆ†åˆ«ä¸é€‰æ‹©é›†çš„å„å…ƒç´ ç»‘å®šï¼›

```
var data = [10, 20, 30];
d3.selectAll("circle")
  .data(data)
  .style("fill", "pink")
  .attr("r", function(d, i) { return d; }) // d å’Œ i åˆ†åˆ«å¯¹åº”æ•°æ®å’Œç´¢å¼•
  .attr("cx", function(d, i) { return i * 100 + 50; });
```
#### Update & Enter & Exit

è¿™æ˜¯ D3 ä¸­æ¯”è¾ƒé‡è¦çš„ä¸‰ä¸ªæ¦‚å¿µï¼Œç”¨æ¥å¤„ç†é€‰æ‹©é›†å’Œæ•°æ®çš„æ•°é‡å…³ç³»ä¸ç¡®å®šçš„æƒ…å†µã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ•°æ®ç»‘å®šæŒ‰ç…§ç´¢å¼•è¿›è¡ŒåŒ¹é…ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ å’Œæ•°ç»„ä¸­ç¬¬ä¸€ä¸ªæ•°æ®ç»‘å®šï¼Œä»¥æ­¤ç±»æ¨ã€‚åœ¨æ•°æ®ç»‘å®šæ—¶ï¼Œä¼šäº§ç”Ÿä¸‰ä¸ªé€‰æ‹©é›†ç”¨æ¥ä»£è¡¨ä¸‰ç§ä¸åŒçš„çŠ¶æ€ï¼š Updateã€Enterã€ Exitã€‚ å…¶ä¸­ï¼Œä¸æ•°æ®ç›¸åŒ¹é…çš„å…ƒç´ å±äº Update é€‰æ‹©é›†, å½“æ•°æ®æ¯”å…ƒç´ å¤šæ—¶ï¼Œå¤šå‡ºæ¥çš„æ•°æ®ç¼ºå°‘ç›¸åº”çš„å…ƒç´ ä¸ä¹‹åŒ¹é…ï¼Œè¿™éƒ¨åˆ†ç¼ºå¤±çš„å…ƒç´ å±äº Enter é€‰æ‹©é›†ï¼Œå½“æ•°æ®æ¯”å…ƒç´ å°‘æ—¶ï¼Œå¤šä½™çš„å…ƒç´ å±äº Exit é€‰æ‹©é›†ã€‚

çœ‹ä¸‹é¢çš„å°æ —å­ğŸŒ°

æœ‰ä¸‰ä¸ªåœ† ~ åœˆåœˆåœ†åœ†åœˆåœˆ ~

```
<svg width="600" height="400">
	<circle cx="100" cy="200" r="50"></circle>
	<circle cx="300" cy="200" r="50"></circle>
	<circle cx="500" cy="200" r="50"></circle>
</svg>
```
ä½¿ç”¨ D3 çš„æ•°æ®ç»‘å®šï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```
var data = [10, 20, 30, 40];
var svg = d3.select("svg");

// DATA JOIN
var circle = svg.selectAll("circle").data(data);

// Update
circle
 .style("fill", "pink")
 .attr("r", function(d, i) { return d; })
 .attr("cx", function(d, i) { return i * 100 + 50; })
 .attr("cy", function(d, i) { return i * 100 + 50; });

// Enter
circle.enter().append("circle")
 .style("fill", "blue")
 .attr("r", function(d, i) { return d; })
 .attr("cx", function(d, i) { return i * 100 + 50; })
 .attr("cy", function(d, i) { return i * 100 + 50; });
```

ğŸ‘‰ selection.data() è¿”å›çš„æ˜¯ update selectionï¼Œè€Œ enter selection å’Œ exit selection æ˜¯æŒ‚åœ¨ update é€‰æ‹©é›†ä¸Šçš„ï¼Œåˆ†åˆ«é€šè¿‡ selection.enter() å’Œ selection.exit() æ¥è·å¾—ã€‚

ä¸Šé¢æ —å­ä¸­ï¼Œå¯¹äº update é€‰æ‹©é›†å’Œ enter é€‰æ‹©é›†çš„åœ†åˆ†åˆ«æ·»åŠ ä¸åŒé¢œè‰²ï¼Œä½†æ˜¯å¯¹äºåŠå¾„å’Œåœ†å¿ƒä½ç½®çš„æ“ä½œæ˜¯ä¸€æ ·çš„ã€‚å¯ä»¥å°† Enter éƒ¨åˆ†æ”¹æˆä¸‹é¢çš„å†™æ³•ğŸ‘‡ï¼Œå‡å°‘ä¸€äº›é‡å¤ï¼š

```
// Update + Enter
// After merging the entered elements with the update selection,
// apply operations to both

circle.enter().append("circle")
  .style("fill", "blue")
  .merge(circle)
  .attr("r", function(d, i) { return d; })
  .attr("cx", function(d, i) { return i * 100 + 50; })
  .attr("cy", function(d, i) { return i * 100 + 50; });
```
å†çœ‹ä¸€ä¸ªå°æ —å­ğŸŒ° æ­¤æ—¶ä¸€å¼€å§‹ä¸€ä¸ªåœ†ä¹Ÿæ²¡æœ‰ ~ ~

```
<svg width="600" height="400"></svg>
```
ä½†æ˜¯ä¾ç„¶å¯ä»¥é€šè¿‡ selectAll æ¥é€‰æ‹©å¹¶ä¸å­˜åœ¨çš„ circle å…ƒç´ åˆ›å»ºé€‰æ‹©é›†ï¼Œå¹¶ä¸æ•°ç»„ç»‘å®šï¼Œæ­¤æ—¶ update é€‰æ‹©é›†ä¸ºç©ºã€‚

```
var data = [10, 20, 30, 40];
var circle = d3.select('svg')
 .selectAll("circle")
 .data(data);

circle.enter()
 .append("circle")
 .style("fill", 'blue')
 .attr("r", function(d, i) { return d; })
 .attr("cx", function(d, i) { return i * 100 + 50; })
 .attr("cy", function(d, i) { return i * 100 + 50; });
```
[D3 Gallery]:https://github.com/d3/d3/wiki/Gallery
[D3 Selection]:https://github.com/d3/d3-selection/blob/master/README.md

ğŸ‘‰ enter é€‰æ‹©é›†ä¸€å¼€å§‹æ‰€åŒ…å«çš„å…ƒç´ åªæ˜¯ä¸€äº›å ä½ç¬¦è€Œä¸æ˜¯ DOM å…ƒç´ ã€‚è¿™äº›å ä½ç¬¦å…¶å®åªæ˜¯å¸¦æœ‰`__data__`å±æ€§çš„ç®€å•å¯¹è±¡ï¼Œè€Œä¸”å ä½ç¬¦åªæ˜¯ä¸´æ—¶çš„ï¼Œå½“è°ƒç”¨ append æˆ– insert åå°±è¢«æ–°åˆ›å»ºçš„ DOM å…ƒç´ æ›¿ä»£ã€‚

æœ€åï¼Œå¯¹äº Exit é€‰æ‹©é›†çš„æ“ä½œæ¯”è¾ƒç®€å•ï¼Œé€šå¸¸ç›´æ¥æŠŠå¤šä½™çš„å…ƒç´ åˆ é™¤å°±å¯ä»¥ã€‚å‡è®¾ä¸€å¼€å§‹è¿˜æ˜¯ä¸‰ä¸ªåœ†ï¼Œç»‘å®šçš„æ•°ç»„æœ‰ä¸¤ä¸ªæ•°æ®ï¼ŒæŠŠå¤šä½™çš„ä¸€ä¸ªå…ƒç´ åˆ é™¤ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```
// Exit  
circle.exit().remove();
```


### å‚è€ƒ & æ¨è

- è¿›ä¸€æ­¥äº†è§£ Selection, æ¨è D3 ä½œè€… Mike Bostock çš„æ–‡ç« : [How Selections Work]
  

- å…³äºæ•°æ®ç»‘å®š, åŒæ ·æ¨è D3 ä½œè€…çš„å‡ ç¯‡æ–‡ç« ï¼š
	- [Three Little Circles]
	- [Thinking with Joins]
	- [General Update Pattern]



[D3 Gallery]:https://github.com/d3/d3/wiki/Gallery
[D3 Selection]:https://github.com/d3/d3-selection/blob/master/README.md
[How Selections Work]:https://bost.ocks.org/mike/selection/
[Three Little Circles]:https://bost.ocks.org/mike/circles/
[Thinking with Joins]:https://bost.ocks.org/mike/join/
[General Update Pattern]:https://bl.ocks.org/mbostock/3808218
